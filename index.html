<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق مباشر للجميع</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f9; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px;}
        button { padding: 15px 30px; background: #0070f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;}
        button:hover { background: #0051a2; }
        
        #messages-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 300px; }
        .message-card { border-bottom: 1px solid #eee; padding: 15px 0; animation: fadeIn 0.5s; }
        .time { font-size: 12px; color: #888; margin-top: 5px; display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <h2 style="text-align: center;">المنصة العامة (تحديث لحظي)</h2>

    <div class="input-group">
        <input type="text" id="msgInput" placeholder="اكتب رسالتك هنا لتظهر للجميع...">
        <button id="sendBtn">نشر</button>
    </div>

    <div id="messages-container">
        <p style="text-align: center; color: gray;">جاري تحميل البيانات...</p>
    </div>

    <script type="module">
        // 1. استدعاء المكتبات
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ⚠️⚠️ هام: استبدل هذا الجزء ببياناتك الحقيقية التي نسختها سابقاً ⚠️⚠️
       const firebaseConfig = {
  apiKey: "AIzaSyDZ-FQmlixBq6TvaJStsZb5TWmz5hrpTjI",
  authDomain: "help-me-4229a.firebaseapp.com",
  databaseURL: "https://help-me-4229a-default-rtdb.firebaseio.com",
  projectId: "help-me-4229a",
  storageBucket: "help-me-4229a.firebasestorage.app",
  messagingSenderId: "808831432210",
  appId: "1:808831432210:web:e5dc52c416f81dfc5acacb",
  measurementId: "G-088Q1P6E4X"
        };

        // تهيئة التطبيق
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const collectionName = "public_posts"; // اسم الجدول في قاعدة البيانات

        // عناصر الصفحة
        const input = document.getElementById("msgInput");
        const btn = document.getElementById("sendBtn");
        const container = document.getElementById("messages-container");

        // ---------------------------------------------------------
        // أولاً: كود الاستماع التلقائي (يعمل لوحده عند فتح الموقع)
        // ---------------------------------------------------------
        const q = query(collection(db, collectionName), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
            container.innerHTML = ""; // تنظيف الشاشة لرسم البيانات الجديدة

            snapshot.forEach(doc => {
                const data = doc.data();
                
                // إنشاء شكل الرسالة
                const div = document.createElement("div");
                div.className = "message-card";
                
                // تنسيق الوقت
                let dateString = "الآن";
                if (data.createdAt) {
                    dateString = data.createdAt.toDate().toLocaleTimeString('ar-EG');
                }

                div.innerHTML = `
                    <div style="font-size: 18px; color: #333;">${data.text}</div>
                    <span class="time">${dateString}</span>
                `;
                container.appendChild(div);
            });

            if (snapshot.empty) {
                container.innerHTML = '<p style="text-align: center;">لا توجد رسائل بعد.. كن أول من يكتب!</p>';
            }
        });

        // ---------------------------------------------------------
        // ثانياً: كود زر الإرسال
        // ---------------------------------------------------------
        btn.addEventListener("click", async () => {
            const text = input.value;
            if (!text.trim()) return; // منع إرسال الفراغ

            try {
                btn.disabled = true; // تعطيل الزر مؤقتاً
                btn.innerText = "جاري النشر...";
                
                await addDoc(collection(db, collectionName), {
                    text: text,
                    createdAt: serverTimestamp()
                });

                input.value = ""; // مسح الخانة
            } catch (error) {
                console.error("Error:", error);
                alert("حدث خطأ في الإرسال");
            } finally {
                btn.disabled = false;
                btn.innerText = "نشر";
            }
        });

    </script>
</body>
</html>
